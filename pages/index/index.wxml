<view class="page">
  <!-- 顶部 -->
  <view class="hero-container">
    <view class="hero {{heroHeight <= 160 ? 'collapsed' : 'expanded'}}" style="height: {{heroHeight}}rpx;">
      <image class="hero-bg" src="/data/background.jpg" mode="aspectFill" />
      <view class="hero-content">
        <view class="brand">
          <view class="title">暖食记</view>
          <view class="welcome-text">欢迎回来，大厨 臣巳</view>
          <view class="collapsed-text">来选选今天吃什么吧</view>
        </view>
        <view class="hero-middle">
          <view class="day-counter">一起吃饭的第{{dayCount}}天</view>
        </view>
      </view>
      <!-- 展开/收起箭头 -->
      <view class="toggle-arrow" bindtap="toggleHero">
        <text wx:if="{{heroHeight > 160}}" class="arrow-icon">▲</text>
        <text wx:else class="arrow-icon">▼</text>
      </view>
    </view>
    
    <!-- 搜索栏：跟随标签栏上移 -->
    <view class="search-wrapper {{heroHeight <= 160 ? 'collapsed' : 'expanded'}}">
      <view class="search-bar">
        <icon class="icon-box-img" type="search" size="14"></icon>
        <input class="search-input" placeholder="搜索菜名或口味" bindinput="onSearchInput" value="{{searchQuery}}" confirm-type="search" />
      </view>
    </view>
  </view>

  <!-- 分类 -->
  <scroll-view class="cat-bar" scroll-x>
    <view class="cat-row">
      <view
        wx:for="{{categories}}"
        wx:key="*this"
        class="cat-chip {{selectedCategory===item ? 'active' : ''}}"
        data-cat="{{item}}"
        bindtap="selectCategory"
      >
        {{item}}
      </view>
    </view>
  </scroll-view>

  <!-- 菜谱列表 -->
  <scroll-view class="list" scroll-y>
    <view class="waterfall">
      <view class="column">
        <view
          wx:for="{{leftColumnRecipes}}"
          wx:key="id"
          class="recipe-card"
          data-id="{{item.id}}"
          bindtap="openRecipe"
        >
          <image
            class="cover"
            src="{{item.image}}"
            mode="aspectFill"
            style="height: {{item.cardHeight}}rpx;"
          />
          <view class="card-body">
            <view class="card-title">{{item.title}}</view>
            <view class="card-meta">
              <text>{{item.time}}</text>
              <view class="meta-actions">
                <view class="actions">
                  <view class="action like {{item.isLiked ? 'active' : ''}} {{likeAnimId===item.id ? 'anim' : ''}}" data-id="{{item.id}}" catchtap="toggleLike">
                    <image wx:if="{{item.isLiked}}" class="action-icon" src="/data/components/like.png" mode="aspectFit" />
                    <image wx:else class="action-icon" src="/data/components/preLike.png" mode="aspectFit" />
                    <text class="action-count">{{item.likeCount}}</text>
                  </view>
                  <view class="action collect {{item.isFav ? 'active' : ''}} {{favAnimId===item.id ? 'anim' : ''}}" data-id="{{item.id}}" catchtap="toggleFavorite">
                    <image wx:if="{{item.isFav}}" class="action-icon" src="/data/components/collect.png" mode="aspectFit" />
                    <image wx:else class="action-icon" src="/data/components/preCollect.png" mode="aspectFit" />
                    <text class="action-count">{{item.favoriteCount}}</text>
                  </view>
                </view>
              </view>
            </view>
            <view class="tag-row">
              <view class="tag" wx:for="{{item.tags}}" wx:key="*this">{{item}}</view>
            </view>

          </view>
        </view>
      </view>

      <view class="column">
        <view
          wx:for="{{rightColumnRecipes}}"
          wx:key="id"
          class="recipe-card"
          data-id="{{item.id}}"
          bindtap="openRecipe"
        >
          <image
            class="cover"
            src="{{item.image}}"
            mode="aspectFill"
            style="height: {{item.cardHeight}}rpx;"
          />
          <view class="card-body">
            <view class="card-title">{{item.title}}</view>
            <view class="card-meta">
              <text>{{item.time}}</text>
              <view class="meta-actions">
                <view class="actions">
                  <view class="action like {{item.isLiked ? 'active' : ''}} {{likeAnimId===item.id ? 'anim' : ''}}" data-id="{{item.id}}" catchtap="toggleLike">
                    <image wx:if="{{item.isLiked}}" class="action-icon" src="/data/components/like.png" mode="aspectFit" />
                    <image wx:else class="action-icon" src="/data/components/preLike.png" mode="aspectFit" />
                    <text class="action-count">{{item.likeCount}}</text>
                  </view>
                  <view class="action collect {{item.isFav ? 'active' : ''}} {{favAnimId===item.id ? 'anim' : ''}}" data-id="{{item.id}}" catchtap="toggleFavorite">
                    <image wx:if="{{item.isFav}}" class="action-icon" src="/data/components/collect.png" mode="aspectFit" />
                    <image wx:else class="action-icon" src="/data/components/preCollect.png" mode="aspectFit" />
                    <text class="action-count">{{item.favoriteCount}}</text>
                  </view>
                </view>
              </view>
            </view>
            <view class="tag-row">
              <view class="tag" wx:for="{{item.tags}}" wx:key="*this">{{item}}</view>
            </view>

          </view>
        </view>
      </view>
    </view>

    <view wx:if="{{filteredRecipes.length===0}}" class="empty">
      暂无匹配菜谱，换个关键词试试～
    </view>
  </scroll-view>

  <!-- 弹层：菜谱详情与流水线步骤 -->
  <view wx:if="{{showModal}}" class="modal">
    <view class="mask" catchtouchmove="noop" bindtap="closeModal"></view>
    <view
      class="modal-panel"
      catchtouchmove="noop"
      bindtouchstart="onModalTouchStart"
      bindtouchend="onModalTouchEnd"
    >
      <view class="pull-hint"></view>
      <view class="modal-header">
        <view class="modal-row">
          <view class="modal-title">{{activeRecipe.title}}</view>
          <view class="modal-row-right">
            <view class="modal-counts">
              <text class="count like">❤ {{activeRecipe.likes}}</text>
              <text class="count fav">★ {{activeRecipe.favoriteCount}}</text>
            </view>
            <button class="cook-btn" size="mini" bindtap="startCook">开做！</button>
          </view>
        </view>
        <view class="modal-desc">{{activeRecipe.description}}</view>
      </view>

      <scroll-view class="modal-scroll" scroll-y>
        <view class="section">
          <view class="section-title">用料</view>
          <view class="pill-row">
            <view class="pill" wx:for="{{activeRecipe.ingredients}}" wx:key="*this">{{item}}</view>
          </view>
        </view>

        <view class="section">
          <view class="section-title">烹饪步骤（{{activeStepIndex + 1}} / {{activeRecipe.steps.length}}）</view>
          <swiper
            class="step-swiper"
            current="{{activeStepIndex}}"
            bindchange="onStepChange"
            previous-margin="32rpx"
            next-margin="32rpx"
          >
            <swiper-item wx:for="{{activeRecipe.steps}}" wx:key="index">
              <view class="step-card">
                <view class="step-index">步骤 {{index + 1}}</view>
                <view class="step-text">{{item}}</view>
              </view>
            </swiper-item>
          </swiper>

        </view>
      </scroll-view>
    </view>
  </view>
</view>
